@{
    ViewBag.Title = "Purchase Order";
    Layout = "~/Views/Shared/_MasterLayout.cshtml";
}
@section styles{

    <script type="text/javascript" src="js/script.js"></script>


<style>
    .textarea {
        min-height: 62px !important;
        max-height: 62px !important;
    }
</style>

}



<div class="row">
    <div class="col-md-10"></div>
    <div class="col-md-2">
        <a class="btn btn-success" href="/Transaction/Transaction/PurchaseOrderList" title="Purchase Order List">Purchase Order List</a>
    </div>
</div>
</br>
<div class="card border-primary">
    <div class="card-body">
        <div class="alert alert-success text-center divsuccess hidden">
        </div>
        <div class="alert alert-danger text-center diverror hidden">
        </div>
        <div class="row">
            <div class="col-md-12"></div>
            <div class="col-md-2">

                <label><b>PO NO</b><span style="color: red;"> *</span></label>
            </div>

            <div class="col-md-4">
                <input type="hidden" id="hdnPOId" value="0" />
                <input type="text" class="form-control" value="" id="txtPoNo" disabled />
            </div>
            <div class="col-md-2">

                <label><b>PO Date</b><span style="color: red;"> *</span></label>
            </div>

            <div class="col-md-4">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text">
                            <i class="fa fa-calendar"></i>
                        </span>
                    </div>
                    <input type="text" id="txtPoDate" onkeydown="return false;" class="form-control">
                    <div class="errorPoDate custom-error hidden">
                        <p style="color: red;" class="help-block">
                            Select PO Date
                        </p>
                    </div>
                </div>
            </div>

        </div>
        <br />

        <div class="row">
            <div class="col-md-12"></div>
            <div class="col-md-2">

                <label><b>Intent No</b></label>
            </div>

            <div class="col-md-4">
                <input type="text" value="" class="form-control" id="txtIntentNo" />
                <!-- Dropdown List Option -->

            </div>
            <div class="col-md-2">

                <label><b>Intent Date</b></label>
            </div>
            <div class="col-md-4">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text">
                            <i class="fa fa-calendar"></i>
                        </span>
                    </div>
                    <input type="text" id="txtintentdate" onkeydown="return false;" class="form-control">
                </div>
            </div>
        </div>

        <br />

        <div class="row">
            <div class="col-md-12"></div>
            <div class="col-md-2">

                <label><b>Enquiry No</b></label>
            </div>

            <div class="col-md-4">
                <input type="text" value="" class="form-control" id="txtEnquiryNo" />
                <!-- Dropdown List Option -->

            </div>
            <div class="col-md-2">

                <label><b>Enquiry Date</b></label>
            </div>
            <div class="col-md-4">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text">
                            <i class="fa fa-calendar"></i>
                        </span>
                    </div>
                    <input type="text" id="txtEnquirydate" onkeydown="return false;" class="form-control">
                </div>
            </div>
        </div>
        <br />
        <div class="row">
            <div class="col-md-12"></div>
            <div class="col-md-2">

                <label><b>Quotation No</b></label>
            </div>

            <div class="col-md-4">
                <input type="text" value="" class="form-control" id="txtQuotationNo" />
                <!-- Dropdown List Option -->

            </div>
            <div class="col-md-2">

                <label><b>Quotation Date</b></label>
            </div>
            <div class="col-md-4">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text">
                            <i class="fa fa-calendar"></i>
                        </span>
                    </div>
                    <input type="text" id="txtQuotationdate" onkeydown="return false;" class="form-control">
                </div>
            </div>
        </div>
        <br />
        <div class="row">
            <div class="col-md-12"></div>
            <div class="col-md-2">

                <label><b>Supplier</b><span style="color: red;"> *</span></label>
            </div>

            <div class="col-md-4">
                <input type="hidden" id="selectedSupplierId" value="0" />
                <input class="form-control" id="txtSupplier" type="text" placeholder="Search...">
                <div class="errorSupplier custom-error hidden">
                    <p style="color: red;" class="help-block">
                        Choose Supplier
                    </p>
                </div>
            </div>
            <div class="col-md-2">

                <label><b>Bill Date</b></label>
            </div>
            <div class="col-md-4">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text">
                            <i class="fa fa-calendar"></i>
                        </span>
                    </div>
                    <input type="text" id="txtBilldate" onkeydown="return false;" class="form-control">
                </div>
            </div>
        </div>
        <br />
        <div class="row">
            <div class="col-md-12"></div>
            <div class="col-md-2">

                <label><b>Requested By</b><span style="color: red;"> *</span></label>
            </div>

            <div class="col-md-4">
                <input type="text" value="" class="form-control" id="txtRequestedby" />
                <div class="errorRequestedby custom-error hidden">
                    <p style="color: red;" class="help-block">
                        Enter Requested By
                    </p>
                </div>

            </div>

            <div class="col-md-2">

                <label><b>Due Date</b><span style="color: red;"> *</span></label>
            </div>

            <div class="col-md-4">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text">
                            <i class="fa fa-calendar"></i>
                        </span>
                    </div>
                    <input type="text" id="txtDuedate" onkeydown="return false;" class="form-control" />
                    <div class="errorDuedate custom-error hidden">
                        <p style="color: red;" class="help-block">
                            Select Due Date
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-2 hidden">

                <label><b>PO Type</b><span style="color: red;"> *</span></label>
            </div>
            <div class="col-md-4 hidden">
                <input type="text" value="" class="form-control" id="txtPOType" />
                <div class="errorPOType custom-error hidden">
                    <p style="color: red;" class="help-block">
                        Select PO Type
                    </p>
                </div>

            </div>
        </div>
        <br />


        <div class="row">
            <div class="col-md-12">
                <div class="alert alert-danger text-center divitemerrormessage hidden">
                </div>
                <div class="mappingdiv" style="overflow-x: scroll;">


                    <table id="itemtable" width="100%" class="display table table-striped table-bordered dataTable no-footer">
                        <thead>
                            <tr>
                                <th class="text-center">Item Name <span style="color: red">*</span></th>
                                <th class="text-center">Unit</th>
                                <th class="text-center">Quantity <span style="color: red">*</span></th>
                                <th class="text-center">Rate <span style="color: red">*</span></th>
                                <th class="text-center">CGST % </th>
                                <th class="text-center">CGST Value </th>
                                <th class="text-center">SGST % </th>
                                <th class="text-center">SGST Value </th>
                                <th class="text-center">IGST % </th>
                                <th class="text-center">IGST Value </th>
                                <th class="text-center">Total</th>
                                <th class="text-center" style='width: 100px;'>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>

                    </table>
                </div>
            </div>
        </div>
        <br />

        <div class="row">
            <div class="col-md-12"></div>
            <div class="col-md-2">

                <label><b>Delievery Schedule</b><span style="color: red;"> *</span></label>
            </div>



            <div class="col-md-4">
                <select class="form-control" name="drpDeliverySchedule" id="drpDeliverySchedule" tabindex="-1" aria-hidden="true">


                    <option value="">-Select-</option>
                    <option value="10 Days">10 Days</option>
                    <option value="15 Days">15 Days</option>
                    <option value="30 Days">30 Days</option>
                </select>
                <div class="errorDeliverySchedule custom-error hidden">
                    <p style="color: red;" class="help-block">
                        Select Delivery Schedule
                    </p>
                </div>
            </div>
            <div class="col-md-2">
                <label><b>Delivery Type</b><span style="color: red;"> *</span></label>
            </div>

            <div class="col-md-4">
                <select class="form-control" name="txtDeliveryType" id="txtDeliveryType" tabindex="-1" aria-hidden="true">
                    <option value="">-Select-</option>
                    <option value="Road">Road</option>
                    <option value="Railway">Railway</option>
                    <option value="Airway">Airway</option>
                </select>
                <div class="errorDeliveryType custom-error hidden">
                    <p style="color: red;" class="help-block">
                        Enter Delivery Type
                    </p>
                </div>

            </div>

        </div>
        <br />
        <div class="row">
            <div class="col-md-2 text-right">
                <label><b>Courier Charges</b></label>
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control gridCalculation" onkeypress='return validateFloatKeyPress(this,event);' value="0.00" id="txtCourierCharges" />
            </div>
            <div class="col-md-4"></div>

            <div class="col-md-2 text-right">
                <label><b>Sub Total:</b></label>
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control" value="0.00" id="txtSubTotal" disabled />
            </div>


        </div>
        <div class="row">
            <div class="col-md-8"></div>
            <div class="col-md-2 text-right">
                <label><b>CGST:</b></label>
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control" value="0.00" id="txtCGST" disabled />
            </div>
        </div>
        <div class="row">
            <div class="col-md-8"></div>
            <div class="col-md-2 text-right">
                <label><b>SGST:</b></label>
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control" value="0.00" id="txtSGST" disabled />
            </div>
        </div>
        <div class="row">
            <div class="col-md-8"></div>
            <div class="col-md-2 text-right">
                <label><b>IGST:</b></label>
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control" value="0.00" id="txtIGST" disabled />
            </div>
        </div>
        <div class="row">
            <div class="col-md-8"></div>
            <div class="col-md-2 text-right">
                <label><b>Total:</b></label>
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control" value="0.00" id="txtTotal" disabled />
            </div>
        </div>

        <br />



        <div class="pull-right btnRequest">
            <div class="btn btn-success " id="btnSave" title="Submit">Submit</div>
            <div class="btn btn-warning " title="Cancel" id="btnclose">Cancel</div>

        </div>
    </div>
</div>



@section scripts{

    <script>
        $(function () {
            $("#txtintentdate").datepicker();
            $("#txtEnquirydate").datepicker();
            $("#txtQuotationdate").datepicker();
            $("#txtDuedate").datepicker();
            $("#txtBilldate").datepicker();
            $("#txtPoDate").datepicker().datepicker("setDate", new Date());
        });
    </script>
<script type="text/javascript">




    $(document).ready(function () {
        var POId = getQueryString("POId");
        if (POId != null) {
            EditPO(POId);
        } else {
            getAccountYear();
            AppendTR();
        }
        $("#txtSupplier").mcautocomplete({
            showHeader: true,
            columns: [{
                name: 'Code',
                width: '150px',
                valueField: 'CustomerCode'
            }, {
                name: 'Name',
                width: '150px',
                valueField: 'CustomerName'
            }],
            select: function (event, ui) {
                this.value = (ui.item ? ui.item.CustomerName : '');
                $("#selectedSupplierId").val(ui.item.CustomerId);
                $("#itemtable tbody tr").remove();
                AppendTR();
                return false;
            },
            change: function (event, ui) {
                if (!ui.item) {
                    this.value = "";
                    $("#selectedSupplierId").val("0");
                    $("#itemtable tbody tr").remove();
                    AppendTR();
                }
            },
            minLength: 1,
            source: function (request, response) {
                $.ajax({
                    type: "POST",
                    url: "/Master/Master/getUserList",
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    data: "{ 'type':'Supplier','prefix':'" + request.term + "'}",
                    success: function (data) {
                        var result;
                        if (!data || data.length === 0) {
                            result = [{
                                CustomerCode: 'No records found.',
                                CustomerName: ""
                            }];
                        } else {
                            result = data;
                        }
                        response(result);
                    }
                });
            }
        });

    });

    function EditPO(poid) {
        $.ajax({
            url: "/Transaction/Transaction/GetPOById",
            type: "GET",
            data: { POId: poid },
            cache: false,
            success: function (result) {
                $("#hdnPOId").val(result.PoModel.POId);
                $("#txtPoNo").val(result.PoModel.PONo);
                $("#txtPoDate").val(moment(result.PoModel.PODate).format("MM/DD/YYYY"));
                $("#txtIntentNo").val(result.PoModel.IntentNo);
                if (result.PoModel.IntentDate != null) {
                    $("#txtintentdate").val(moment(result.PoModel.IntentDate).format("MM/DD/YYYY"));
                } else {
                    $("#txtintentdate").val("");
                }
                $("#txtEnquiryNo").val(result.PoModel.EnquiryNo);
                if (result.PoModel.EnquiryDate != null) {
                    $("#txtEnquirydate").val(moment(result.PoModel.EnquiryDate).format("MM/DD/YYYY"));
                } else {
                    $("#txtEnquirydate").val("");
                }
                $("#txtQuotationNo").val(result.PoModel.QuotationNo);
                if (result.PoModel.QuotationDate != null) {
                    $("#txtQuotationdate").val(moment(result.PoModel.QuotationDate).format("MM/DD/YYYY"));
                } else {
                    $("#txtQuotationdate").val("");
                }
                $("#selectedSupplierId").val(result.PoModel.SupplierId);
                if (result.PoModel.BillDate != null) {
                    $("#txtBilldate").val(moment(result.PoModel.BillDate).format("MM/DD/YYYY"));
                } else {
                    $("#txtBilldate").val("");
                }
                $("#txtRequestedby").val(result.PoModel.RequestedBy);
                $("#txtPOType").val(result.PoModel.POType);
                if (result.PoModel.DueDate != null) {
                    $("#txtDuedate").val(moment(result.PoModel.DueDate).format("MM/DD/YYYY"));
                } else {
                    $("#txtDuedate").val("");
                }
                $("#txtSubTotal").val(result.PoModel.SubTotal);
                $("#txtCGST").val(result.PoModel.CGST);
                $("#txtSGST").val(result.PoModel.SGST);
                $("#txtIGST").val(result.PoModel.IGST);
                $("#txtTotal").val(result.PoModel.Total);
                $("#drpDeliverySchedule").val(result.PoModel.DeliverySchedule);
                $("#txtDeliveryType").val(result.PoModel.DeliveryType);
                $("#txtSupplier").val(result.PoModel.SupplierName);

                $("#itemtable tbody tr").remove();
                for (var columnCt = 0; columnCt < result.POItemModel.length; columnCt++) {
                    AppendTR();
                }
                var itemDetailsCount = $("#itemtable tbody tr").length;
                var itemDetailsTable = $("#itemtable").find('tbody tr');

                if (itemDetailsCount > 0) {
                    $(itemDetailsTable).each(function (i, v) {

                        $(v).find('.hdnItemId').val(result.POItemModel[i].ItemId);
                        $(v).find('.txtquantity').val(result.POItemModel[i].Quantity);
                        $(v).find('.txtcgstpers').val(result.POItemModel[i].CGSTPer);
                        $(v).find('.txtcgstvalue').val(result.POItemModel[i].CGSTAmount);
                        $(v).find('.txtSgstpers').val(result.POItemModel[i].SGSTPer);
                        $(v).find('.txtsgstvalue').val(result.POItemModel[i].SGSTAmount);
                        $(v).find('.txtigstpers').val(result.POItemModel[i].IGSTPer);
                        $(v).find('.txtigstvalue').val(result.POItemModel[i].IGSTAmount);
                        $(v).find('.txttotal').val(result.POItemModel[i].Total);
                        $(v).find('.txtRate').val(result.POItemModel[i].Rate);
                        $(v).find('.txtunit').val(result.POItemModel[i].ItemUnit);
                        $(v).find('.txtItemName').val(result.POItemModel[i].ItemName);
                    });
                }
                gridCalculation();
            }

        });
    }

    function AppendTR() {
        var trCount = $("#itemtable tbody tr").length;
        var str = "<tr>";
        str += "<td><input type='hidden' value='0' class='hdnItemId'/><input type='Text' value='' id='txtgriditemname' style='width: 200px;' placeholder='Search item...' class='txtItemName approvalcheck form-control'></input></td>";
        str += "<td><input type='Text' value='' style='width: 125px;' class='txtunit Item approvalcheck form-control' disabled></input></td>";
        str += "<td><input type='Text' value='0' style='width: 125px;' onkeypress='return validateFloatKeyPress(this,event);' class='txtquantity gridCalculation Item approvalcheck form-control'></input></td>";
        str += "<td><input type='Text' value='0.00' style='width: 100px;' onkeypress='return validateFloatKeyPress(this,event);' class='txtRate  gridCalculation approvalcheck form-control'></input></td>";
        str += "<td><input type='Text' value='0.00' style='width: 100px;' onkeypress='return validateFloatKeyPress(this,event);' class='txtcgstpers gridCalculation approvalcheck form-control'></input></td>";
        str += "<td><input type='Text' value='0.00' style='width: 100px;' class='txtcgstvalue  approvalcheck form-control' disabled></input></td>";
        str += "<td><input type='Text' value='0.00' style='width: 100px;' onkeypress='return validateFloatKeyPress(this,event);' class='txtSgstpers gridCalculation approvalcheck form-control'></input></td>";
        str += "<td><input type='Text' value='0.00' style='width: 100px;' class='txtsgstvalue  approvalcheck form-control' disabled></input></td>";
        str += "<td><input type='Text' value='0.00' style='width: 100px;'onkeypress='return validateFloatKeyPress(this,event);' class='txtigstpers gridCalculation approvalcheck form-control'></input></td>";
        str += "<td><input type='Text' value='0.00' style='width: 100px;' class='txtigstvalue  approvalcheck form-control' disabled></input></td>";
        str += "<td><input type='Text' value='0.00' style='width: 100px;' class='txttotal  approvalcheck form-control' disabled></input></td>";
        str += "<td class='text-center'><button class='addrow btn btn-success btn-xs' title='add row' type='button' aria-label='addRow'><i class='fa fa-plus'></i></button> <button class='delrow btn btn-danger btn-xs' title='Remove this row' type='button' aria-label='addRow'><i class='fa fa-times'></i></button></td>";
        str += "</tr>";
        $('#itemtable').append(str);
        var rowCount = $('#itemtable >tbody >tr').length;
        var str = 'txtgriditemname' + rowCount + getAppRandomNumber();
        var transactiondate = $('#itemtable tr:last').find('.txtItemName').attr('id', str);
        gridAutocomplete('#' + str);
        $(".gridCalculation").change(function () {
            gridCalculation();
        });
    }

    function gridAutocomplete(selector) {
        $(selector).mcautocomplete({
            showHeader: true,
            columns: [{
                name: 'Code',
                width: '150px',
                valueField: 'ItemCode'
            }, {
                name: 'Name',
                width: '150px',
                valueField: 'ItemName'
            }, {
                name: 'Unit',
                width: '100px',
                valueField: 'Unit'
            }, {
                name: 'Rate',
                width: '80px',
                valueField: 'Rate'
            }],
            select: function (event, ui) {
                this.value = (ui.item ? ui.item.ItemName : '');
                $(selector).closest('tr').find(".hdnItemId").val(ui.item.ItemId);
                $(selector).closest('tr').find(".txtunit").val(ui.item.Unit);
                $(selector).closest('tr').find(".txtRate").val(ui.item.Rate);
                // $("#selectedUserId").html(ui.item.ItemId);
                return false;
            },
            change: function (event, ui) {
                if (!ui.item) {
                    this.value = "";
                    $(selector).closest('tr').find(".hdnItemId").val("0");
                    $(selector).closest('tr').find(".txtunit").val("");
                    $(selector).closest('tr').find(".txtRate").val("");
                }
            },
            minLength: 1,
            source: function (request, response) {
                $.ajax({
                    type: "POST",
                    url: "/Transaction/Transaction/getItemListByCustomer",
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    data: "{ 'CustomerId':'" + $('#selectedSupplierId').val() + "','prefix':'" + request.term + "'}",
                    success: function (data) {
                        var result;
                        if (!data || data.length === 0) {
                            result = [{
                                ItemCode: 'No records found.',
                                ItemName: "",
                                Unit: "",
                                Rate: ""
                            }];
                        } else {
                            result = data;
                        }
                        response(result);
                    }
                });
            }
        });
    }

    $("#btnclose").click(function () {

        window.location = "/Transaction/Transaction/Purchase";
    });

    function checkvalidation() {
        var formCollectionResult = {};
        formCollectionResult.timesubtransaction = [];
        var familyDetailsCount = $("#itemtable tbody tr").length;
        var familyDetailsTable = $("#itemtable").find('tbody tr');
        var isValid = true;
        $(familyDetailsTable).each(function (i, v) {
            if ($(v).find('.txtItemName').val() == "") {
                isValid = false;
            }
            if ($(v).find('.hdnItemId').val() == "0") {
                isValid = false;
            }
            if ($(v).find('.txtquantity').val() === "") {
                isValid = false;
            } else if (!checkIsNumber($(v).find('.txtquantity').val())) {
                isValid = false;
            } else if (checkIsZero($(v).find('.txtquantity').val())) {
                isValid = false;
            }
            if ($(v).find('.txtRate').val() === "") {
                isValid = false;
            } else if (!checkIsNumber($(v).find('.txtRate').val())) {
                isValid = false;
            } else if (checkIsZero($(v).find('.txtRate').val())) {
                isValid = false;
            }
        });
        return isValid;
    }

    function gridCalculation() {
        if (checkvalidation() == true) {
            var OverAllSubTotal = parseFloat(0.00);
            var OverAllCGST = parseFloat(0.00);
            var OverAllSGST = parseFloat(0.00);
            var OverAllIGST = parseFloat(0.00);
            var OverAllTotal = parseFloat(0.00);
            var CourierCharges = $("#txtCourierCharges").val();

            if (CourierCharges == "") {
                CourierCharges = "0.00";
                $('#txtCourierCharges').val(CourierCharges);
            }
            var familyDetailsCount = $("#itemtable tbody tr").length;
            var familyDetailsTable = $("#itemtable").find('tbody tr');
            $(familyDetailsTable).each(function (i, v) {
                var qty = $(v).find('.txtquantity').val();
                var rate = $(v).find('.txtRate').val();
                var sgstper = $(v).find('.txtSgstpers').val();
                var cgstper = $(v).find('.txtcgstpers').val();
                var igstper = $(v).find('.txtigstpers').val();
                rate = parseFloat(rate);
                var total = 0.00;
                var subtotal = qty * rate;
                OverAllSubTotal += parseFloat(subtotal);
                if (sgstper == "") {
                    sgstper = "0.00";
                    $(v).find('.txtSgstpers').val(sgstper);
                }
                if (cgstper == "") {
                    cgstper = "0.00";
                    $(v).find('.txtcgstpers').val(cgstper);
                }
                if (igstper == "") {
                    igstper = "0.00";
                    $(v).find('.txtigstpers').val(igstper);
                }
                sgstper = parseFloat(sgstper);
                cgstper = parseFloat(cgstper);
                igstper = parseFloat(igstper);
                var cgstvalue = subtotal * (cgstper.toFixed(2) / 100.00);
                var sgstvalue = subtotal * (sgstper.toFixed(2) / 100.00);
                var igstvalue = subtotal * (igstper.toFixed(2) / 100.00);
                total = subtotal + cgstvalue + sgstvalue + igstvalue;
                total = parseFloat(total);
                OverAllCGST += parseFloat(cgstvalue);
                OverAllSGST += parseFloat(sgstvalue);
                OverAllIGST += parseFloat(igstvalue);
                OverAllTotal += parseFloat(total);

                $(v).find('.txtcgstvalue').val(cgstvalue.toFixed(2));
                $(v).find('.txtsgstvalue').val(sgstvalue.toFixed(2));
                $(v).find('.txtigstvalue').val(igstvalue.toFixed(2));
                $(v).find('.txttotal').val(total.toFixed(2));

            });
            OverAllTotal = parseFloat(OverAllTotal) + parseFloat(CourierCharges);
            $("#txtSubTotal").val(OverAllSubTotal.toFixed(2));
            $("#txtCGST").val(OverAllCGST.toFixed(2));
            $("#txtSGST").val(OverAllSGST.toFixed(2));
            $("#txtIGST").val(OverAllIGST.toFixed(2));
            $("#txtTotal").val(OverAllTotal.toFixed(2));
            TotalCalculation();
        }
    }

    function TotalCalculation() {

    }

    $("#itemtable tbody").on('click', '.addrow', function () {
        debugger;

        var isValid = checkvalidation();
        if (isValid) {

            AppendTR();
        }
        else {
            $(".divitemerrormessage").removeClass("hidden").html("Marked * field are mandatory");
            window.setTimeout(function () {
                $(".divitemerrormessage").addClass("hidden")
            }, 5000);
        }


    });

    $("#itemtable tbody").on('click', '.delrow', function () {
        if ($(this).parent().parent()[0].rowIndex > 1) {
            $(this).parents('tr').remove();
            gridCalculation();
            //var table = $('#customertable').DataTable();
            //table.row($(this).parents('tr')).remove().draw();
        } else if ($("#itemtable tbody tr").length > 1) {
            $(this).parent().parent().remove();
            gridCalculation();
        }

    });


    function getAccountYear() {
        $.ajax({
            type: "POST",
            url: "/Transaction/Transaction/GetCurrentPONo",
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                $("#txtPoNo").val(data);
            }
        });
    }

    $("#btnSave").click(function () {
        gridCalculation();
        var hdnPOId = $("#hdnPOId").val();
        var txtPoNo = $("#txtPoNo").val();
        var txtPoDate = $("#txtPoDate").val();
        var txtIntentNo = $("#txtIntentNo").val();
        var txtintentdate = $("#txtintentdate").val();
        var txtEnquiryNo = $("#txtEnquiryNo").val();
        var txtEnquirydate = $("#txtEnquirydate").val();
        var txtQuotationNo = $("#txtQuotationNo").val();
        var txtQuotationdate = $("#txtQuotationdate").val();
        var selectedSupplierId = $("#selectedSupplierId").val();
        var txtBilldate = $("#txtBilldate").val();
        var txtRequestedby = $("#txtRequestedby").val();
        var txtPOType = $("#txtPOType").val();
        var txtDuedate = $("#txtDuedate").val();
        var txtSubTotal = $("#txtSubTotal").val();
        var txtCGST = $("#txtCGST").val();
        var txtSGST = $("#txtSGST").val();
        var txtIGST = $("#txtIGST").val();
        var txtTotal = $("#txtTotal").val();
        var drpDeliverySchedule = $("#drpDeliverySchedule").val();
        var txtDeliveryType = $("#txtDeliveryType").val();
        var txtCourierCharges = $("#txtCourierCharges").val();
        txtPOType = "";
        var vaild = true;

        $(".errorPoDate").addClass("hidden");
        $(".errorSupplier").addClass("hidden");
        $(".errorRequestedby").addClass("hidden");
        $(".errorPOType").addClass("hidden");
        $(".errorDuedate").addClass("hidden");
        $(".errorDeliverySchedule").addClass("hidden");
        $(".errorDeliveryType").addClass("hidden");
        $(".divitemerrormessage").addClass("hidden");

        if (selectedSupplierId == "" || selectedSupplierId == "0") {
            $(".errorSupplier").removeClass("hidden");
            vaild = false;
        }
        if (txtPoDate == "") {
            $(".errorPoDate").removeClass("hidden");
            vaild = false;
        }
        if (txtRequestedby == "") {
            $(".errorRequestedby").removeClass("hidden");
            vaild = false;
        }
        //if (txtPOType == "") {
        //    $(".errorPOType").removeClass("hidden");
        //    vaild = false;
        //}
        if (txtDuedate == "") {
            $(".errorDuedate").removeClass("hidden");
            vaild = false;
        }
        if (drpDeliverySchedule == "") {
            $(".errorDeliverySchedule").removeClass("hidden");
            vaild = false;
        }
        if (txtDeliveryType == "") {
            $(".errorDeliveryType").removeClass("hidden");
            vaild = false;
        }

        var objPO = {
            POId: hdnPOId,
            PODate: txtPoDate,
            AccountYear: "",
            IncrementId: 0,
            PONo: txtPoNo,
            IntentNo: txtIntentNo,
            IntentDate: txtintentdate,
            EnquiryNo: txtEnquiryNo,
            EnquiryDate: txtEnquirydate,
            QuotationNo: txtQuotationNo,
            QuotationDate: txtQuotationdate,
            SupplierId: selectedSupplierId,
            BillDate: txtBilldate,
            RequestedBy: txtRequestedby,
            POType: txtPOType,
            DueDate: txtDuedate,
            SubTotal: txtSubTotal,
            CGST: txtCGST,
            SGST: txtSGST,
            IGST: txtIGST,
            Total: txtTotal,
            DeliverySchedule: drpDeliverySchedule,
            DeliveryType: txtDeliveryType,
            IsActive: 1,
            Createdby: 0,
            Createdon: null,
            Modifiedby: null,
            Modifiedon: null,
            CourierCharges: txtCourierCharges
        };

        var objModel = {};
        objModel.POModel = objPO;
        objModel.POSubItemList = [];
        var itemDetailsCount = $("#itemtable tbody tr").length;
        var itemDetailsTable = $("#itemtable").find('tbody tr');
        var isValid = checkvalidation();
        if (isValid == false) {
            vaild = isValid;
            $(".divitemerrormessage").removeClass("hidden").html("Marked * field are mandatory");
        }
        if (!vaild) {
            return;
        }

        var totalItems = [];
        if (itemDetailsCount > 0) {
            $(itemDetailsTable).each(function (i, v) {

                var ItemId = $(v).find('.hdnItemId').val();
                var txtquantity = $(v).find('.txtquantity').val();
                var txtRate = $(v).find('.txtRate').val();
                var txtcgstpers = $(v).find('.txtcgstpers').val();
                var txtcgstvalue = $(v).find('.txtcgstvalue').val();
                var txtSgstpers = $(v).find('.txtSgstpers').val();
                var txtsgstvalue = $(v).find('.txtsgstvalue').val();
                var txtigstpers = $(v).find('.txtigstpers').val();
                var txtigstvalue = $(v).find('.txtigstvalue').val();
                var txttotal = $(v).find('.txttotal').val();

                totalItems.push(ItemId);
                var objExp = {
                    SubPOId: 0,
                    POId: hdnPOId,
                    ItemId: ItemId,
                    Quantity: txtquantity,
                    Rate: txtRate,
                    CGSTPer: txtcgstpers,
                    CGSTAmount: txtcgstvalue,
                    SGSTPer: txtSgstpers,
                    SGSTAmount: txtsgstvalue,
                    IGSTPer: txtigstpers,
                    IGSTAmount: txtigstvalue,
                    Total: txttotal,
                    IsActive: 1,
                    Createdby: 0,
                    Createdon: null,
                    Modifiedby: null,
                    Modifiedon: null
                };
                objModel.POSubItemList.push(objExp);
            });
        }

        var uinqItem = [];
        $.each(totalItems, function (i, el) {
            if ($.inArray(el, uinqItem) == -1) {
                uinqItem.push(el);
            }
        });
        if (uinqItem.length != itemDetailsCount) {
            $(".divitemerrormessage").removeClass("hidden").html("Duplicate items found.");
            return;
        }

        $.ajax({
            url: "/Transaction/Transaction/SavePurchaseOrder",
            contentType: 'application/json',
            cache: false,
            type: "post",
            traditional: true,
            async: true,
            data: JSON.stringify({ model: objModel }),
            success: function (response) {
                if (response.success == true) {
                    //$(".divsuccess").removeClass("hidden");
                    //$(".divsuccess").html(response.message);
                    //window.setTimeout(function () {
                    //    $(".divsuccess").addClass("hidden")
                    //}, 5000);
                    //ItemmapList();

                    swal({
                        title: response.message,
                        text: "",
                        type: "success",
                        showCancelButton: false,
                        confirmButtonClass: "btn-success",
                        confirmButtonText: "Ok",
                        closeOnConfirm: true
                    },
                     function () {
                         window.location = "/Transaction/Transaction/Purchase"
                     });

                    //refreshScreen();

                } else {
                    //$(".diverror").removeClass("hidden");
                    //$(".diverror").html(response.message);
                    //window.setTimeout(function () {
                    //    $(".diverror").addClass("hidden")
                    //}, 5000);
                    swal(response.message, "", "danger")
                }
            },
            error: function (xhr, status, error) {

            }
        });

    });

    function refreshScreen() {
        $("#hdnPOId").val("0");
        $("#txtPoNo").val("");
        $("#txtPoDate").datepicker().datepicker("setDate", new Date());
        $("#txtIntentNo").val("");
        $("#txtintentdate").val("");
        $("#txtEnquiryNo").val("");
        $("#txtEnquirydate").val("");
        $("#txtQuotationNo").val("");
        $("#txtQuotationdate").val("");
        $("#selectedSupplierId").val("0");
        $("#txtBilldate").val("");
        $("#txtRequestedby").val("");
        $("#txtPOType").val("");
        $("#txtDuedate").val("");
        $("#txtSubTotal").val("0.00");
        $("#txtCGST").val("0.00");
        $("#txtSGST").val("0.00");
        $("#txtIGST").val("0.00");
        $("#txtTotal").val("0.00");
        $("#drpDeliverySchedule").val("");
        $("#txtDeliveryType").val("");
        $("#txtSupplier").val();
        getAccountYear();
        $("#itemtable tbody tr").remove();
        AppendTR();
    }


</script>
}



